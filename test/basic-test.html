<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes" />

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../../juicy-tile-table/juicy-tile-table.html" />
    <link rel="import" href="../src/juicy-tile-simple-editor.html" />
</head>
<body>

    <test-fixture id="editor-form-fixture">
        <template>
            <div style="padding: 0px; margin: 0px;">
                <template is="dom-bind">
                    <juicy-tile-simple-editor></juicy-tile-simple-editor>
                    <juicy-tile-table id="table-0" setup="{{model.setup0}}" defaultsetup="{{model.setupCopy}}">
                        <div class="tile-0">tile-00</div>
                        <div class="tile-1">tile-01</div>
                    </juicy-tile-table>
                    <juicy-tile-table id="table-1" setup="{{model.setup1}}" defaultsetup="{{model.setupCopy}}">
                        <div class="tile-0">tile-10</div>
                        <div class="tile-1">tile-11</div>
                    </juicy-tile-table>
                </template>
                <script>
                    (function () {
                        var script = document._currentScript || document.currentScript;
                        var tempalte = script.previousElementSibling;
                        var setup = function () {
                            return JSON.parse(JSON.stringify({
                                gutter: 0,
                                width: 480,
                                direction: "horizontal",
                                items: [
                                    { width: "100%", widthFlexible: true, id: 0, hidden: false, heightDynamic: true, height: 1, priority: 1 },
                                    { width: "100%", widthFlexible: true, id: 1, hidden: false, heightDynamic: true, height: 1, priority: 0.9 }
                                ]
                            }));
                        };

                        tempalte.model = {
                            setup0: setup(),
                            setup1: setup(),
                            setupCopy: setup()
                        };
                    })();
                </script>
            </div>
        </template>
    </test-fixture>

    <script src="helpers.js"></script>
    <script>
        var page = {
            width: 1000
        };

        suite("<juicy-tile-simple-editor>", function () {
            var fix;
            var editor;
            var tables;
            var tw;

            setup(function () {
                fix = fixture("editor-form-fixture");
                editor = fix.querySelector("juicy-tile-simple-editor");

                tables = Array.prototype.slice.call(fix.querySelectorAll("juicy-tile-table"));
                tw = new JuicyTileTableWrapper(tables[0]);

                fix.style.width = page.width + "px";

                setTimeout(function () {
                    editor.set("showTree", true);
                }, 10);
            });

            test("finds all <juicy-tile-table> on the page", function () {
                tables.forEach(function (t, i) {
                    expect(editor.lists[i]).to.equal(t);
                });
            });

            test("hides and shows sidebar", function (done) {
                setTimeout(function () {
                    var btn = Polymer.dom(editor.root).querySelector(".editor-tabs button.btn-tree");
                    click(btn);
                }, 100);

                setTimeout(function () {
                    var tree = Polymer.dom(editor.root).querySelector(".editor-tree");
                    var btn = Polymer.dom(editor.root).querySelector(".editor-tabs button.btn-tree");

                    expect(tree).to.have.deep.property("style.display", "none");
                    click(btn, 25);
                }, 150);

                setTimeout(function () {
                    var tree = Polymer.dom(editor.root).querySelector(".editor-tree");

                    expect(tree).to.have.deep.property("style.display", "");
                    done();
                }, 200);
            });

            test("selects <juicy-tile-table> on click", function (done) {
                click(tw.table, 100);

                setTimeout(function () {
                    expect(editor.selectedTiles[0]).to.equal(tw.table);
                    done();
                }, 200);
            });

            test("scopes into <juicy-tile-table> on double click", function (done) {
                dblclick(tw.table, 100);

                setTimeout(function () {
                    expect(editor.selectedTiles).to.be.empty;
                    expect(editor.selectedList).to.equal(tw.table);
                    done();
                }, 200);
            });

            test("selects a tile on click", function (done) {
                dblclick(tw.table, 100);
                click(tw.tile(0), 150);

                setTimeout(function () {
                    var td = tw.cell(0);

                    expect(editor.selectedTiles).to.have.length(1);
                    expect(editor.selectedTiles[0]).to.equal(td);
                    done();
                }, 200);
            });

            test("selects another tile on click", function (done) {
                dblclick(tw.table, 100);
                click(tw.tile(0), 125);
                click(tw.tile(1), 150);

                setTimeout(function () {
                    var td = tw.cell(1);

                    expect(editor.selectedTiles).to.have.length(1);
                    expect(editor.selectedTiles[0]).to.equal(td);
                    done();
                }, 200);
            });

            /*test("selects multiple tiles on ctrl + click", function (done) {
                dblclick(tw.table, 100);
                click(tw.tile(0), 125);
                ctrlClick(tw.tile(1), 150);

                setTimeout(function () {
                    var td0 = tw.cell(0);
                    var td1 = tw.cell(1);

                    assert.equal(editor.selectedTiles.length, 2);
                    assert.equal(editor.selectedTiles[0], td0);
                    assert.equal(editor.selectedTiles[1], td1);
                    done();
                }, 200);
            });*/

            test("changes width of a tile on width button click", function (done) {
                dblclick(tw.table, 100);
                click(tw.tile(0), 125);

                setTimeout(function () {
                    var btn = Polymer.dom(editor.root).querySelector(".editor-simple-form .width-section button:nth-child(6)");
                    click(btn);
                }, 150);
                
                setTimeout(function () {
                    var rec = tw.tile(0).getBoundingClientRect();
                    expect(rec.width).to.be.equal(page.width / 2);
                    done();
                }, 200);
            });

            test("changes priority of a tile on priority arrow button click", function (done) {
                dblclick(tw.table, 100);
                click(tw.tile(0), 125);

                setTimeout(function () {
                    var btn = Polymer.dom(editor.root).querySelector(".editor-simple-form .position-section button:nth-child(2)");
                    click(btn);
                }, 150);

                setTimeout(function () {
                    var td = tw.nthCell(1);
                    expect(td).to.have.property("id", "1");
                    done();
                }, 200);
            });

            test("hides a tile on eye button click", function (done) {
                dblclick(tw.table, 100);
                click(tw.tile(0), 125);

                setTimeout(function () {
                    var btn = Polymer.dom(editor.root).querySelector(".editor-simple-form .visible-section button");
                    click(btn);
                }, 150);

                setTimeout(function () {
                    var tds = tw.cells();
                    expect(tds).to.have.length(1);
                    expect(tds[0]).to.have.property("id", "1");
                    done();
                }, 200);
            });
        });
    </script>
</body>
</html>