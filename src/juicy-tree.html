<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../polymer-ui-menu/polymer-ui-menu.html">
<link rel="import" href="../../polymer-ui-menu-item/polymer-ui-menu-item.html">
<link rel="import" href="../../polymer-ui-submenu-item/polymer-ui-submenu-item.html">

<polymer-element name="juicy-tree" attributes="tree selectedBranch">
  <template>
    <style>
      ul {
        list-style: none;
        padding: 0 0 0 20px;
      }

      li .selected {
        background-color: blue;
        color: white;
      }
    </style>

    <ul class="root">
      <template repeat="{{ tree as branch }}" id="recursive">
        <!-- branch -->
        <li>
          <span on-tap="{{activateBranch}}">{{ branch | toDisplayName }} ▾</span>

          <ul class="branch">
            <template repeat="{{ branch.setup.items as item }}" id="item">
              <!-- item -->
              <li>
                <template if="{{ item.items }}">
                  <!-- group -->
                  <span on-tap="{{activateBranch}}">{{ item | toDisplayName }} ▾</span>

                  <ul class="group">
                    <template repeat="{{ item.items as item }}" ref="item"></template>
                  </ul>
                </template>

                <template if="{{ !item.items }}" id="element">
                  <!-- real element -->

                  <template if="{{ !branch.branches[ item.index ] }}">
                    <!-- without nested juicy-tiles -->

                    <span on-tap="{{activateBranch}}">{{ item | toDisplayName }}</span>
                  </template>
                  <template if="{{ branch.branches[ item.index ] }}">
                    <!-- with nested juicy-tiles -->
                    <span on-tap="{{activateBranch}}">{{ item | toDisplayName }} ▾</span>

                    <ul class="group">
                      <template repeat="{{ branch.branches[ item.index ] as branch }}" ref="recursive"></template>
                    </ul>
                  </template>
                </template>
              </li>
            </template>
          </ul>
        </li>
      </template>
    </ul>

    <shadow></shadow>
  </template>
  <script>
    (function () {
      Polymer('juicy-tree', {
        tree: [],
        /**
         * Converts branch object to a display name string. Can be overloaded
         * @param branch
         * @returns {String}
         */
        toDisplayName: function (branch) {
          if (branch.name != void 0) {
            return branch.name
          }
          else {
            return "Unnamed element"
          }
        },
        activateBranch: function (ev, index, target) {
          ev.stopImmediatePropagation();
          if(ev.ctrlKey || ev.metaKey || ev.shiftKey) {
            //this.highlightBranch(target.templateInstance.model.branch, true);
          }
          else {
            //this.highlightBranch(target.templateInstance.model.branch);
            var model = target.templateInstance.model;
            var proto = Object.getPrototypeOf(model);
            if(model.branch === proto.branch) { //a branch of a leaf (branch is inherited from prototype)
              this.fire('juicy-tree-activate', {branch: target.templateInstance.model.item, tiles: target.templateInstance.model.branch.node});
            }
            else if(model.item === proto.item) { //a nested tiles (item is inherited from prototype)
              this.fire('juicy-tree-activate', {branch: target.templateInstance.model.branch.setup, tiles: target.templateInstance.model.branch.node});
            }

            Array.prototype.slice.call(this.shadowRoot.querySelectorAll('.selected')).forEach(function(li){
              li.classList.remove('selected');
            });
            target.classList.add('selected');
          }
        },
        highlightBranch: function (branch, expand) {
          return;
          /*var direct = true;

          //normalize
          var menus = this.shadowRoot.querySelectorAll('polymer-ui-submenu-item, #menu');
          for (var i = 0, ilen = menus.length; i < ilen; i++) {
            if (!Array.isArray(menus[i].selected)) {
              menus[i].selected = [];
              if (menus[i].nodeName === "POLYMER-UI-SUBMENU-ITEM") {
                menus[i].shadowRoot.querySelector("polymer-ui-menu").multi = true;
              }
            }
            if (!expand) {
              menus[i].selected.length = 0;
            }
            if (menus[i].activeChanged) {
              menus[i].activeChanged = undefined;
            }
            if (menus[i].activate) {
              menus[i].activate = undefined;
            }
          }

          //expand tree recursively
          var menuItems = this.shadowRoot.querySelectorAll('polymer-ui-menu-item, polymer-ui-submenu-item');
          var item = branch;
          while (item) {
            var menuItem = null;
            for (var i = 0, ilen = menuItems.length; i < ilen; i++) {
              if (menuItems[i].templateInstance.model.branch == item) {
                menuItem = menuItems[i];
              }
            }

            if (menuItem) {
              var parent = menuItem.parentNode;
              if (direct) {
                var siblings = parent.items;
                for (var i = 0, ilen = siblings.length; i < ilen; i++) {
                  if (siblings[i] === menuItem) {
                    var index = parent.selected.indexOf(i);
                    if (index == -1) {
                      parent.selected.push(i);
                      this.fire('juicy-tree-selection-add', {branch: item});
                    }
                    else {
                      parent.selected.splice(index, 1);
                      this.fire('juicy-tree-selection-remove', {branch: item});
                    }
                    break;
                  }
                }
                if (parent.selected.length == 1 && this.lastHighlightedBranch == item) {
                  menuItem.collapsed = !menuItem.collapsed;
                  parent.collapsed = !parent.collapsed;
                }
                else {
                  menuItem.collapsed = false;
                  parent.collapsed = false;
                }
              }
              else {
                menuItem.collapsed = false;
                parent.collapsed = false;
              }
            }

            item = item.container;
            direct = false;
          }

          this.lastHighlightedBranch = branch;
          */
        },
        preventSelection: function(ev) {
          //ev.preventDefault();
        }
      });
    })();
  </script>
</polymer-element>