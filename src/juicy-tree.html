<link rel="import" href="../../polymer/polymer.html">

<polymer-element name="juicy-tree" attributes="tree">
  <template>
    <style>
      ul {
        list-style: none;
        padding: 0 0 0 20px;
      }

      li span {
        cursor: default;
      }

      li span.selected {
        background-color: blue;
        color: white;
      }
    </style>

    <ul class="root" on-mousedown="{{preventTextSelection}}">
      <template repeat="{{ tree as branch }}" id="recursive">
        <!-- branch -->
        <li>
          <span on-tap="{{activateBranch}}">{{ branch | toDisplayName }} ▾</span>

          <ul class="branch">
            <template repeat="{{ branch.setup.items as item }}" id="item">
              <!-- item -->
              <li>
                <template if="{{ item.items }}">
                  <!-- group -->
                  <span on-tap="{{activateBranch}}">{{ item | toDisplayName }} ▾</span>

                  <ul class="group">
                    <template repeat="{{ item.items as item }}" ref="item"></template>
                  </ul>
                </template>

                <template if="{{ !item.items }}" id="element">
                  <!-- real element -->

                  <template if="{{ !branch.branches[ item.index ] }}">
                    <!-- without nested juicy-tiles -->

                    <span on-tap="{{activateBranch}}">{{ item | toDisplayName }}</span>
                  </template>
                  <template if="{{ branch.branches[ item.index ] }}">
                    <!-- with nested juicy-tiles -->
                    <span on-tap="{{activateBranch}}">{{ item | toDisplayName }} ▾</span>

                    <ul class="group">
                      <template repeat="{{ branch.branches[ item.index ] as branch }}" ref="recursive"></template>
                    </ul>
                  </template>
                </template>
              </li>
            </template>
          </ul>
        </li>
      </template>
    </ul>

    <shadow></shadow>
  </template>
  <script>
    (function () {
      Polymer('juicy-tree', {
        tree: [],
        /**
         * Converts branch object to a display name string. Can be overloaded
         * @param branch
         * @returns {String}
         */
        toDisplayName: function (branch) {
          if (branch.name != void 0) {
            return branch.name
          }
          else {
            return "Unnamed element"
          }
        },
        activateBranch: function (ev, index, target) {
          var eventName;
          if(ev.ctrlKey || ev.metaKey || ev.shiftKey) {
            if(target.classList.contains('selected')) {
              eventName = 'juicy-tree-selection-remove';
              target.classList.remove('selected');
            }
            else {
              eventName = 'juicy-tree-selection-add';
              target.classList.add('selected');
            }
          }
          else {
            eventName = 'juicy-tree-activate';
            Array.prototype.slice.call(this.shadowRoot.querySelectorAll('.selected')).forEach(function(span){
              span.classList.remove('selected');
            });
            target.classList.add('selected');
          }
          var model = target.templateInstance.model;
          var proto = Object.getPrototypeOf(model);
          if(model.branch === proto.branch) { //a branch of a leaf (branch is inherited from prototype)
            this.fire(eventName, {branch: target.templateInstance.model.item, tiles: target.templateInstance.model.branch.node});
          }
          else if(model.item === proto.item) { //a nested tiles (item is inherited from prototype)
            this.fire(eventName, {branch: target.templateInstance.model.branch.setup, tiles: target.templateInstance.model.branch.node});
          }
        },
        highlightBranch: function (branch, expand) {
          //TODO this does not highlight multiselection because recreation of .tree[] rerenders the templates
          Array.prototype.slice.call(this.shadowRoot.querySelectorAll('span')).forEach(function(span){
            if(span.templateInstance.model.item === branch) {
              span.classList.add('selected');
            }
          });
        },
        preventTextSelection: function(ev) {
          ev.preventDefault();
        }
      });
    })();
  </script>
</polymer-element>