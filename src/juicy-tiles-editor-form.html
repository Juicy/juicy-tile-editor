<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../juicy-popover/src/juicy-popover.html">
<link rel="import" href="juicy-color-picker.html">

<polymer-element name="juicy-tiles-editor-form" attributes="selectedItems editedTiles">
  <template>
    <style>
      .editablesContainer {
        display: flex;
      }

      .editableGroup {
        flex: 1 1 auto;
        display: flex;
      }

      label {
        display: inline-block;
        white-space: nowrap;
      }

      .val {
        display: inline-block;
        width: 50px;
      }

      .toolbar-item[disabled] {
        opacity: 0.25;
        pointer-events: none;
      }

      button {
        min-height: 1.45em;
        min-width: 1.45em;
        display: inline-block;
        padding: 0;
        margin: 0;
        vertical-align: top;
        line-height: 1;
        font-size: 14px;
        color: #243140;
        text-align: center;
        text-shadow: 0 1px rgba(255,255,255,0.2);
        background: #e5e7ed;
        border: 0;
        border-radius: 2px;
        cursor: pointer;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      button:hover {
        color: #243140;
        background: #dcdfe7;
      }

      button:active,
      .expanded button.handle {
        color: #1d2938;
        background: #cdd1dc;
      }

      .expandable {
        background: #fff;
        border: 1px solid rgba(0, 0, 0, .2);
        box-shadow: 0 5px 10px rgba(0, 0, 0, .2);
        padding: 5px;
        max-width: 144px;
        white-space: normal;
      }
      .expandable.innerHTML{
        width: auto;
        max-width: none;
      }

      .expandable textarea{
        width: 40em;
        height: 5em;
      }

      h4 {
        margin: 0;
        display: inline;
      }

      .toolbar-item {
        display: flex;
        flex-direction: column;
        margin-left: 10px;
      }

      .toolbar-button {
        height: 20px;
        display: inline-block;
        white-space: nowrap;
        box-sizing: border-box;
      }

      .toolbar-button * {
        height: 20px;
        box-sizing: border-box;
      }

      .toolbar-button input{
        background-color: transparent;
      }

      .toolbar-button input{
        border: 1px solid #333;
      }

      .toolbar-button button{
        margin: 0 0 0 -1px;
      }

      .toolbar-button-background {
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .toolbar-label {
        font-size: 10px;
        text-align: center;
      }

      .sidebar {
        position: fixed;
        top: 150px;
        left: 10px;
        width: 200px;
        height: calc(100% - 160px);
        background: white;
        border: 1px solid black;
        opacity: 0.8;
        overflow: auto;
      }

      .sidebar /deep/ #menu {
        margin-left: 10px;
      }
    </style>
    <div class="editablesContainer">
      <div class="editableGroup">
        <h4>Container</h4>

        <div class="toolbar-item" disabled?="{{!isContainer && !isRoot}}">
          <button class="toolbar-button" on-click="{{deleteContainer}}">⧉</button>
          <label class="toolbar-label">Ungroup</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isContainer}}">
          <button class="toolbar-button" on-click="{{changeDirection}}">↷</button>
          <label class="toolbar-label">Direction</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isContainer}}">
          <button class="toolbar-button" on-click="{{stackItems}}">⇟</button>
          <label class="toolbar-label">Stack</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isSelection}}">
          <juicy-popover>
            <button class="handle toolbar-button toolbar-button-background" style='background: {{background}}'>&nbsp;</button>
            <div class="expandable">
              <juicy-color-picker value="{{background}}" on-juicy-color-picker-value-changed="{{refresh}}"></juicy-color-picker>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Background</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isContainer}}">
          <juicy-popover>
            <input class="handle toolbar-button val" placeholder="multiple" on-blur="{{refresh}}" value="{{gap}}">
            <div class="expandable">
              <button class="editable" on-click="{{gapIncrease}}">+</button>
              <button class="editable" on-click="{{gapDecrease}}">-</button>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Gap</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isContainer}}">
          <juicy-popover>
            <input class="handle toolbar-button val" placeholder="multiple" on-blur="{{refresh}}" value="{{oversize}}">
            <div class="expandable">
              <button class="editable" on-click="{{oversizeIncrease}}">+</button>
              <button class="editable" on-click="{{oversizeDecrease}}">-</button>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Oversize</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isSingleSelection}}">
          <juicy-popover>
            <button class="handle toolbar-button">✎</button>
            <div class="expandable innerHTML">
              <textarea on-blur="{{refresh}}" value="{{innerHTML}}"></textarea>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Inner HTML</label>
        </div>
      </div>

      <div class="editableGroup">
        <h4>Selection</h4>

        <div class="toolbar-item" disabled?="{{!isSelection}}">
          <button class="toolbar-button" title="Move selected elements to the same group (CTRL+M)" on-click="{{moveSelectionToEditedItemContainer}}">⧉</button>
          <label class="toolbar-label">Move to group</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isSelection}}">
          <button class="toolbar-button" title="Create a new group from selected elements (CTRL+G)" on-click="{{newGroupFromSelection}}">⧈</button>
          <label class="toolbar-label">New group</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isSelection}}">
          <juicy-popover>
            <input placeholder="multiple" class="handle toolbar-button val" on-blur="{{refresh}}" value="{{width}}" disabled?="{{widthAuto}}">
            <div class="expandable">
              <button class="editable" on-click="{{widthIncrease}}" disabled?="{{widthAuto}}">+</button>
              <button class="editable" on-click="{{widthDecrease}}" disabled?="{{widthAuto}}">-</button>
              <label class="editable"><input id="widthAutoCheckbox" type="checkbox" on-click="{{refresh}}" checked="{{widthAuto}}"> auto</label>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Width</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isSelection}}">
          <juicy-popover>
            <input placeholder="multiple" class="handle toolbar-button val" on-blur="{{refresh}}" value="{{height}}" disabled?="{{heightAuto}}">
            <div class="expandable">
              <button class="editable" on-click="{{heightIncrease}}" disabled?="{{heightAuto}}">+</button>
              <button class="editable" on-click="{{heightDecrease}}" disabled?="{{heightAuto}}">-</button>
              <label class="editable"><input id="heightAutoCheckbox" type="checkbox" on-click="{{refresh}}" checked="{{heightAuto}}"> auto</label>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Height</label>
        </div>

        <div class="toolbar-item" disabled?="{{!isSingleSelection}}">
          <juicy-popover>
            <input class="handle toolbar-button val" value="{{priority}}" disabled>
            <div class="expandable">
              <button class="editable" on-click="{{priorityIncrease}}" disabled?="{{!isSingleSelection}}">+</button>
              <button class="editable" on-click="{{priorityDecrease}}" disabled?="{{!isSingleSelection}}">-</button>
            </div>
          </juicy-popover>
          <label class="toolbar-label">Priority</label>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function () {
      function powerIncrease(obj, property) {
        var power = 1;
        while (power <= obj[property])
          power *= 2;
        obj[property] = power;
      }

      function powerDecrease(obj, property, minimum) {
        var power = 1;
        while (power * 2 < obj[property])
          power *= 2;
        if (power < minimum) {
          power = minimum;
        }
        obj[property] = power;
      }

      Polymer('juicy-tiles-editor-form', {
        isSelection: false,
        isSingleSelection: false,
        selectedItems: [],
        editedTiles: null,
        itemName: null,
        background: null,
        width: null,
        widthAuto: null,
        height: null,
        heightAuto: null,
        gap: null,
        oversize: 0,
        priority: null,
        innerHTML: null,
        getSortableElement: function (elem) {
          while (elem.parentNode) {
            if (elem.parentNode.nodeName == 'JUICY-TILE-LIST') {
              return elem;
            }
            elem = elem.parentNode;
          }
        },
        newGroupFromSelection: function () {
          if (!this.selectedItems.length > 1) {
            return;
          }

          var current = this.selectedItems[0];
          var setup = {
            priority: current.priority,
            gap: 0,
            index: current.index
          }

          var model = this.editedTiles;
          var newContainer = model.createNewContainer(null, current.container, setup, true);
          for (var i = 0, ilen = this.selectedItems.length; i < ilen; i++) {
            model.moveToContainer(this.selectedItems[i], newContainer, true);
          }

          this.selectedItems.length = 0; //change edited item to the new container
          this.selectedItems.push(newContainer);

          var dimensions = model.getMinimumDimensions(this.getContainerChildElements(newContainer));
          newContainer.width = dimensions.width;
          newContainer.height = dimensions.height;

          model.packItems(); //rerender
          this.fire('juicy-tiles-editor-form-tree-changed');
        },
        moveSelectionToEditedItemContainer: function () {
          if (!this.selectedItems.length > 1) {
            return;
          }

          var current = this.selectedItems[0];
          var model = this.editedTiles;
          for (var i = 1, ilen = this.selectedItems.length; i < ilen; i++) {
            model.moveToContainer(this.selectedItems[i], current.container, true);
          }

          var dimensions = model.getMinimumDimensions(this.getContainerChildElements(current.container));
          this.selectedItems[0].container.width = dimensions.width;
          this.selectedItems[0].container.height = dimensions.height;

          model.packItems(); //rerender
          this.fire('juicy-tiles-editor-form-tree-changed');
        },
        getContainerChildElements: function (container) {
        	//FIXME I may not work (tomalec)
          var model = this.editedTiles;
          var elements = [];
          for (var i = 0, ilen = container.items.length; i < ilen; i++) {
            if (container.items[i].index != void 0) {
              elements.push(model.elements[container.items[i].index])
            }
            else if (container.items[i].name != void 0) {
              elements.push(model.elements[container.items[i].name])
            }
          }
          return elements;
        },
        gapIncrease: function () {
          this.gap++;
          this.refresh();
        },
        gapDecrease: function () {
          if (this.gap >= 1) {
            this.gap--;
          }
          this.refresh();
        },
        oversizeIncrease: function () {
          if (this.oversize >= 1) {
            this.oversize++;
          }
          else{
            this.oversize = 1;
          }
          this.refresh();
        },
        oversizeDecrease: function () {
          if (this.oversize >= 1) {
            this.oversize--;
          }
          this.refresh();
        },
        refresh: function () {
          this.editedTiles && this.editedTiles.refresh();
        },
        widthIncrease: function () {
          powerIncrease(this, "width");
          this.refresh();
        },
        widthDecrease: function () {
          powerDecrease(this, "width");
          this.refresh();
        },
        heightIncrease: function () {
          if (this.height == 'auto') { //turn off auto
            this.height = 32;
            this.heightAuto = false;
          }
          powerIncrease(this, "height");
          this.refresh();
        },
        heightDecrease: function () {
          if (this.height == 'auto') { //turn off auto
            this.height = 32;
            this.heightAuto = false;
          }
          powerDecrease(this, "height");
          this.refresh();
        },
        priorityIncrease: function () {
          if (!this.selectedItems.length == 1) {
            return;
          }

          this.editedTiles
            .reprioritizeItem(this.selectedItems[0], true)
            .refresh(); //FIXME: this calls pack items for the second time, consider changing Package.js (tomalec)
          this.priority = this.selectedItems[0].priority;
        },
        priorityDecrease: function () {
          if (!this.selectedItems.length == 1) {
            return;
          }

          this.editedTiles
            .reprioritizeItem(this.selectedItems[0], false)
            .refresh(); //FIXME: this calls pack items for the second time, consider changing Package.js (tomalec)
          this.priority = this.selectedItems[0].priority;
        },
        deleteContainer: function () {
          var deleteElement = this.selectedItems[0];
          this.selectedItems[0] = deleteElement.container;
          this.editedTiles.deleteContainer(deleteElement, true); //do not repack after change
        },
        changeDirection: function(){
          this.selectedItems[0].direction = this.selectedItems[0].direction == "downRight" ? "rightDown" : "downRight";
          this.refresh();
        },
        stackItems: function () {
          for (var i = 0, ilen = this.selectedItems.length; i < ilen; i++) {
            if (this.selectedItems[i].items) {
              this.selectedItems[i].direction = "downRight";
              this.selectedItems[i].heightAuto = true;
              for (var j = 0, jlen = this.selectedItems[i].items.length; j < jlen; j++) {
                this.selectedItems[i].items[j].width = "100%";
              }
            }
          }
          this.refresh();
        },
        isContainerInSelection: function() {
          for (var i = 0, ilen = this.selectedItems.length; i < ilen; i++) {
            if (this.selectedItems[i].items) {
              return true;
            }
          }
          return false;
        },
        isRootInSelection: function() {
          for (var i = 0, ilen = this.selectedItems.length; i < ilen; i++) {
            if (!this.selectedItems[i].container) {
              return true;
            }
          }
          return false;
        },
        getCommonValue: function (propName) {
          if (this.selectedItems.length) {
            var val = this.selectedItems[0][propName];
            for (var i = 1, ilen = this.selectedItems.length; i < ilen; i++) {
              if (this.selectedItems[i][propName] !== val) {
                return ""; //shows "multiple" in placeholder
              }
            }
            return val;
          }
        },
        setCommonValue: function (propName, val) {
          if (val !== "" && this.selectedItems.length) {
            for (var i = 0, ilen = this.selectedItems.length; i < ilen; i++) {
              this.selectedItems[i][propName] = val;
            }
            this.refresh();
          }
        },
        backgroundChanged: function (oldVal, val) {
          this.setCommonValue("background", val);
        },
        widthChanged: function (oldVal, val) {
          this.setCommonValue("widthAuto", false);
          this.setCommonValue("width", val);
        },
        widthAutoChanged: function (oldVal, val) {
          this.setCommonValue("widthAuto", val);
        },
        heightChanged: function (oldVal, val) {
          this.setCommonValue("heightAuto", false);
          this.setCommonValue("height", val);
        },
        heightAutoChanged: function (oldVal, val) {
          this.setCommonValue("heightAuto", val);
        },
        gapChanged: function (oldVal, val) {
          this.setCommonValue("gap", val);
        },
        oversizeChanged: function (oldVal, val) {
          this.setCommonValue("oversize", val);
        },
        innerHTMLChanged: function (oldVal, val) {
          this.setCommonValue("innerHTML", val);
        },
        selectedItemsChanged: function () {
          this.itemName = this.getCommonValue("itemName");
          this.background = this.getCommonValue("background");
          this.width = this.getCommonValue("width");
          this.widthAuto = this.getCommonValue("widthAuto");
          this.height = this.getCommonValue("height");
          this.heightAuto = this.getCommonValue("heightAuto");
          this.gap = this.getCommonValue("gap");
          this.oversize = this.getCommonValue("oversize");
          this.priority = this.getCommonValue("priority");
          this.innerHTML = this.getCommonValue("innerHTML") || ""; //set innerHTML to empty string if undefined is returned
          this.isSelection = (this.selectedItems.length > 0);
          this.isSingleSelection = (this.selectedItems.length == 1);
          this.isContainer = this.isContainerInSelection();
          this.isRoot = this.isRootInSelection();

          Array.prototype.forEach.call(this.shadowRoot.querySelectorAll('input[placeholder]'), function (input) {
            if (this.isSelection && !this.isSingleSelection) {
              input.setAttribute('placeholder', 'multiple'); //display "multiple" text when getCommonValue returns empty string
            }
            else {
              input.setAttribute('placeholder', '');
            }
          }.bind(this));
        }
      });
    })();
  </script>
</polymer-element>
