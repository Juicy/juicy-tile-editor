<dom-module id="juicy-tile-tree-item">
    <template>
        <!-- item -->
        <li class$="{{getLiClass(expanded, item)}}">
            <template is="dom-if" if="{{item.items}}" restamp="true">
                <!-- group -->
                <div class$="{{getBranchClassName(item, tree.highlightedBranches)}}" on-mouseover="hoverAction" on-mouseout="blurAction" title="{{item.id}}" branch="[[branch]]" item="[[item]]">
                    <juicy-toggle-icon-button class="expand" icon-on="jte-icon-angle-down" icon-off="jte-icon-angle-right" 
                                                checked="{{getIsExpanded(expanded, item)}}" on-click="setIsExpanded" item="[[item]]"></juicy-toggle-icon-button>
                    <template is="dom-if" if="{{!getIsItemEdited(editItem, item)}}" restamp="true">
                        <juicy-toggle-icon-button class="visibility" on-click="setVisibility" icon-off="jte-icon-eye" icon-on="jte-icon-eye-off"
                                                  checked$="[[getVisibility(item, item.hidden)]]" value="[[item.itemName]]" item="[[item]]"></juicy-toggle-icon-button>
                    </template>
                    <juicy-draggable on-juicy-draggable-stop="itemDragStop" position="static" dropselector="html /deep/ ul.branch li .drop-item" disabled?="{{getIsItemEdited(editItem, item)}}"
                                    branch="[[branch]]" item="[[item]]">
                        <div on-tap="tapAction" class="txt" branch="[[branch]]" item="[[item]]">
                            <input type="text" class$="{{getInputClassName(editItem, item)}}" readonly$="{{!getIsItemEdited(editItem, item)}}" value="{{item.itemName::change}}"
                                    on-dblclick="itemNameDblclickAction" on-blur="nameBlurAction" on-keypress="nameKeypressAction"
                                    branch="[[branch]]" item="[[item]]" />
                        </div>
                    </juicy-draggable>
                </div>
                <ul class="group">
                    <template is="dom-repeat" items="{{item.items}}" as="item">
                        <juicy-tile-tree-item tree="{{tree}}" expanded="{{expanded}}" branch="[[branch]]" item="[[item]]"></juicy-tile-tree-item>
                    </template>
                </ul>
            </template>

            <template is="dom-if" if="{{!item.items}}" id="element" restamp="true">
                <!-- real element -->

                <template is="dom-if" if="{{!getHasBranches(branch, item)}}">
                    <!-- without nested juicy-tile-list -->
                    <div class$="{{getBranchClassName(item, tree.highlightedBranches)}}" on-mouseover="hoverAction" on-mouseout="blurAction" title="{{item.id}}" branch="[[branch]]" item="[[item]]">
                        <template is="dom-if" if="{{!getIsItemEdited(editItem, item)}}" restamp="true">
                            <juicy-toggle-icon-button class="visibility" on-click="setVisibility" icon-off="jte-icon-eye" icon-on="jte-icon-eye-off"
                                                      checked$="[[getVisibility(item, item.hidden)]]" value="[[item.itemName]]" item="[[item]]"></juicy-toggle-icon-button>
                        </template>
                        <juicy-draggable on-juicy-draggable-stop="itemDragStop" position="static" dropselector="html /deep/ ul.branch li .drop-item" disabled?="{{getIsItemEdited(editItem, item)}}"
                                        branch="[[branch]]" item="[[item]]">
                            <div on-tap="tapAction" class="txt" branch="[[branch]]" item="[[item]]">
                                <input type="text" class$="{{getInputClassName(editItem, item)}}" readonly$="{{!getIsItemEdited(editItem, item)}}" value="{{item.itemName::change}}"
                                        on-dblclick="itemNameDblclickAction" on-blur="nameBlurAction" on-keypress="nameKeypressAction"
                                        branch="[[branch]]" item="[[item]]" />
                            </div>
                        </juicy-draggable>
                    </div>
                </template>
                <template is="dom-if" if="{{getHasBranches(branch, item)}}" restamp="true">
                    <!-- with nested juicy-tile-list -->
                    <div class$="{{getBranchClassName(item, tree.highlightedBranches)}}" on-mouseover="hoverAction" on-mouseout="blurAction" title="{{item.id}}" branch="[[branch]]" item="[[item]]">
                        <juicy-toggle-icon-button class="expand" icon-on="jte-icon-angle-down" icon-off="jte-icon-angle-right"
                                                  checked="{{getIsExpanded(expanded, item)}}" item="[[item]]" on-click="setIsExpanded"></juicy-toggle-icon-button>
                        <template is="dom-if" if="{{!getIsItemEdited(editItem, item)}}" restamp="true">
                            <juicy-toggle-icon-button class="visibility" on-click="setVisibility" icon-off="jte-icon-eye" icon-on="jte-icon-eye-off"
                                                      checked$="[[getVisibility(item, item.hidden)]]" value="[[item.itemName]]" item="[[item]]"></juicy-toggle-icon-button>
                        </template>
                        <juicy-draggable on-juicy-draggable-stop="itemDragStop" position="static" dropselector="html /deep/ ul.branch li .drop-item" disabled?="{{getIsItemEdited(editItem, item}}"
                                        branch="[[branch]]" item="[[item]]">
                            <div on-tap="tapAction" class="txt" branch="[[branch]]" item="[[item]]">
                                <input type="text" class$="{{getInputClassName(editItem, item)}}" readonly$="{{!getIsItemEdited(editItem, item)}}" value="{{item.itemName::change}}"
                                        on-dblclick="itemNameDblclickAction" on-blur="nameBlurAction" on-keypress="nameKeypressAction"
                                        branch="[[branch]]" item="[[item]]" />
                            </div>
                        </juicy-draggable>
                    </div>
                    <ul class="group">
                        <juicy-tile-tree-branch tree="[[tree]]" expanded="[[expanded]]" branches="[[getBranches(branch, item)]]"></juicy-tile-tree-branch>
                    </ul>
                </template>
            </template>
        </li>
    </template>
    <script>
        Polymer({
            is: "juicy-tile-tree-item",
            attached: function () {
            },
            properties: {
                branch: {
                    type: Object
                },
                item: {
                    type: Object
                },
                tree: {
                    type: Object
                },
                expanded: {
                    type: Object
                },
                editItem: {
                    type: Object,
                    value: null
                },
                editBranch: {
                    type: Object,
                    value: null
                }
            },
            getLiClass: function (expanded, item) {
                if (!this.tree) {
                    return "";
                }

                var css = ["drop"];
                var id = this.tree.getFullId(item);

                if (this.tree.expanded[id]) {
                    css.push("expanded");
                } else {
                    css.push("collapsed");
                }

                return css.join(" ");
            },
            getBranchClassName: function (branch) {
                return this.tree.getBranchClassName(branch);
            },
            getInputClassName: function (editItem, item) {
                var css = ["item-name"];

                if (this.tree.editItem == item) {
                    css.push("active");
                }

                return css.join(" ");
            },
            hoverAction: function (ev, index) {
                return this.tree.hoverAction(ev, index);
            },
            blurAction: function (ev, index) {
                return this.tree.blurAction(ev, index);
            },
            refreshTileList: function (ev, index) {
                return this.tree.refreshTileList(ev, index);
            },
            itemDragStop: function (ev, index) {
                return this.tree.itemDragStop(ev, index);
            },
            tapAction: function (ev, index) {
                ev.preventDefault();
                return this.tree.tapAction(ev, index);
            },
            itemNameDblclickAction: function (ev, index) {
                this.tree.itemNameDblclickAction(ev, index);

                this.set("editItem", this.tree.editItem);
                this.set("editBranch", this.tree.editBranch);
            },
            nameBlurAction: function (ev, index) {
                this.tree.nameBlurAction(ev, index);

                this.set("editItem", this.tree.editItem);
                this.set("editBranch", this.tree.editBranch);
            },
            nameKeypressAction: function (ev, index) {
                this.tree.nameKeypressAction(ev, index);

                this.set("editItem", this.tree.editItem);
                this.set("editBranch", this.tree.editBranch);
            },
            getIsExpanded: function (expanded, item) {
                return !!this.tree.expanded[this.tree.getFullId(item)];
            },
            getIsItemEdited: function (editItem, item) {
                return this.tree.editItem == item
            },
            getHasBranches: function (branch, item) {
                return branch.branches[item.id];
            },
            getBranches: function (branch, item) {
                return branch.branches[item.id];
            },
            getVisibility: function (item, hidden) {
                return !!item.hidden;
            },
            setIsExpanded: function (ev, index) {
                return this.tree.setIsExpanded(null, ev.currentTarget.item, ev.currentTarget.checked);
            },
            setVisibility: function (ev, index) {
                var item = ev.currentTarget.item;

                item.hidden = !item.hidden;
                ev.currentTarget.set("checked", item.hidden);
                this.refreshTileList(ev, index);
                ev.preventDefault();
            }
        });
    </script>
</dom-module>