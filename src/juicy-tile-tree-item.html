<dom-module id="juicy-tile-tree-item">
    <template>
        <!-- item -->
        <li class$="{{getLiClass(expanded, item)}}">
            <template is="dom-if" if="{{item.items}}">
                <!-- group -->
                <div class$="{{getBranchClassName(item)}}" on-mouseover="hoverAction" on-mouseout="blurAction" title="{{item.id}}" branch="{{branch}}" item="{{item}}">
                    <juicy-toggle-icon-button class="expand" icon-on="jte-icon-angle-down" icon-off="jte-icon-angle-right" 
                                                checked="{{getIsExpanded(expanded, item)}}" on-change="setIsExpanded" item="{{item}}"></juicy-toggle-icon-button>
                    <template is="dom-if" if="{{!getIsItemEdited(tree.editItem, item)}}">
                        <juicy-toggle-icon-button class="visibility" on-click="refreshTileList" icon-off="jte-icon-eye" icon-on="jte-icon-eye-off" checked="{{item.hidden}}" value="{{item.itemName}}"></juicy-toggle-icon-button>
                    </template>
                    <juicy-draggable on-juicy-draggable-stop="itemDragStop" position="static" dropselector="html /deep/ ul.branch li .drop-item" disabled?="{{getIsItemEdited(tree.editItem, item)}}">
                        <div on-tap="tapAction" class="txt" branch="{{branch}}" item="{{item}}">
                            <input type="text" class$="{{getInputClassName(tree.editItem, item)}}" readonly?="{{!getIsItemEdited(tree.editItem, item)}}" value="{{item.itemName}}"
                                    on-dblclick="itemNameDblclickAction" on-blur="nameBlurAction" on-keypress="nameKeypressAction" />
                        </div>
                    </juicy-draggable>
                </div>
                <ul class="group">
                    <template is="dom-repeat" items="{{item.items}}" as="item">
                        <juicy-tile-tree-item tree="{{tree}}" expanded="{{expanded}}" branch="{{branch}}" item="{{item}}"></juicy-tile-tree-item>
                    </template>
                </ul>
            </template>

            <template is="dom-if" if="{{!item.items}}" id="element">
                <!-- real element -->

                <template is="dom-if" if="{{!getHasBranches(branch, item)}}">
                    <!-- without nested juicy-tile-list -->
                    <div class$="{{getBranchClassName(item)}}" on-mouseover="hoverAction" on-mouseout="blurAction" title="{{item.id}}" branch="{{branch}}" item="{{item}}">
                        <template is="dom-if" if="{{!getIsItemEdited(tree.editItem, item)}}">
                            <juicy-toggle-icon-button class="visibility" on-click="refreshTileList" icon-off="jte-icon-eye" icon-on="jte-icon-eye-off" checked="{{item.hidden}}" value="{{item.itemName}}"></juicy-toggle-icon-button>
                        </template>
                        <juicy-draggable on-juicy-draggable-stop="itemDragStop" position="static" dropselector="html /deep/ ul.branch li .drop-item" disabled?="{{getIsItemEdited(tree.editItem, item)}}">
                            <div on-tap="tapAction" class="txt" branch="{{branch}}" item="{{item}}">
                                <input type="text" class="item-name {{getInputClassName(tree.editItem, item)}}" readonly?="{{editItem != item}}" value="{{item.itemName}}"
                                        on-dblclick="itemNameDblclickAction" on-blur="nameBlurAction" on-keypress="nameKeypressAction" />
                            </div>
                        </juicy-draggable>
                    </div>
                </template>
                <template is="dom-if" if="{{getHasBranches(branch, item)}}">
                    <!-- with nested juicy-tile-list -->
                    <div class$="{{getBranchClassName(item)}}" on-mouseover="hoverAction" on-mouseout="blurAction" title="{{item.id}}" branch="{{branch}}" item="{{item}}">
                        <juicy-toggle-icon-button class="expand" icon-on="jte-icon-angle-down" icon-off="jte-icon-angle-right" checked="{{getIsExpanded(expanded, item)}}"></juicy-toggle-icon-button>
                        <template is="dom-if" if="{{!getIsItemEdited(tree.editItem, item)}}">
                            <juicy-toggle-icon-button class="visibility" on-click="refreshTileList" icon-off="jte-icon-eye" icon-on="jte-icon-eye-off" checked="{{item.hidden}}" value="{{item.itemName}}"></juicy-toggle-icon-button>
                        </template>
                        <juicy-draggable on-juicy-draggable-stop="itemDragStop" position="static" dropselector="html /deep/ ul.branch li .drop-item" disabled?="{{getIsItemEdited(tree.editItem, item}}">
                            <div on-tap="tapAction" class="txt" branch="{{branch}}" item="{{item}}">
                                <input type="text" class="item-name {{getInputClassName(tree.editItem, item)}}" readonly?="{{!getIsItemEdited(tree.editItem, item)}}" value="{{item.itemName}}"
                                        on-dblclick="itemNameDblclickAction" on-blur="nameBlurAction" on-keypress="nameKeypressAction" />
                            </div>
                        </juicy-draggable>
                    </div>
                    <ul class="group">
                        <juicy-tile-tree-branch tree="{{tree}}" expanded="{{expanded}}" branches="{{getBranches(branch, item)}}"></juicy-tile-tree-branch>
                    </ul>
                </template>
            </template>
        </li>
    </template>
    <script>
        Polymer({
            is: "juicy-tile-tree-item",
            properties: {
                branch: {
                    type: Object
                },
                item: {
                    type: Object
                },
                tree: {
                    type: Object
                },
                expanded: {
                    type: Object,
                    notify: true
                }
            },
            getLiClass: function (expanded, item) {
                var css = ["drop"];
                var id = this.tree.getFullId(item);

                if (this.expanded[id]) {
                    css.push("expanded");
                } else {
                    css.push("collapsed");
                }

                return css.join(" ");
            },
            getBranchClassName: function (branch) {
                return this.tree.getBranchClassName(branch);
            },
            getInputClassName: function (editItem, item) {
                var css = ["item-name"];

                if (editItem == item) {
                    css.push("active");
                }

                return css.join(" ");
            },
            hoverAction: function (ev, index) {
                return this.tree.hoverAction(ev, index);
            },
            blurAction: function (ev, index, target) {
                return this.tree.blurAction(ev, index);
            },
            refreshTileList: function (ev, index, target) {
                return this.tree.refreshTileList(ev, index);
            },
            itemDragStop: function (ev, index, target) {
                return this.tree.itemDragStop(ev, index);
            },
            tapAction: function (ev, index, target) {
                return this.tree.tapAction(ev, index);
            },
            itemNameDblclickAction: function (ev, index) {
                return this.tree.itemNameDblclickAction(ev, index);
            },
            nameBlurAction: function (ev, index) {
                return this.tree.nameBlurAction(ev, index);
            },
            nameKeypressAction: function (ev, index) {
                return this.tree.nameKeypressAction(ev, index);
            },
            getIsExpanded: function (expanded, item) {
                return !!this.tree.expanded[this.tree.getFullId(item)];
            },
            getIsItemEdited: function (editItem, item) {
                return editItem == item
            },
            getHasBranches: function (branch, item) {
                return branch.branches[item.id];
            },
            getBranches: function (branch, item) {
                return branch.branches[item.id];
            },
            setIsExpanded: function (ev, index) {
                var item = ev.currentTarget.item;
                var value = ev.currentTarget.checked;
                var id = this.tree.getFullId(item);

                this.expanded[id] = value;
                this.notifyPath("expanded", {});
                this.notifyPath("expanded", this.expanded);
            }
        });
    </script>
</dom-module>